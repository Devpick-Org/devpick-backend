name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - develop

permissions:
  pull-requests: write
  contents: read

jobs:
  claude-review:
    if: startsWith(github.head_ref, 'claude/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        run: |
          git fetch origin develop
          git diff origin/develop...HEAD | head -c 10000 > /tmp/pr_diff.txt
          echo "Diff size: $(wc -c < /tmp/pr_diff.txt) bytes"

      - name: Claude ì½”ë“œ ë¦¬ë·°
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          REPO: ${{ github.repository }}
        run: |
          python3 << 'PYEOF'
          import os, json, urllib.request, sys

          diff = open('/tmp/pr_diff.txt', encoding='utf-8', errors='replace').read()
          pr_number = int(os.environ['PR_NUMBER'])
          pr_title = os.environ['PR_TITLE']
          api_key = os.environ['ANTHROPIC_API_KEY']
          github_token = os.environ['GITHUB_TOKEN']
          repo = os.environ['REPO']

          if not diff.strip():
              print("ë³€ê²½ì‚¬í•­ ì—†ìŒ, ë¦¬ë·° ìƒëžµ")
              sys.exit(0)

          # Claude API í˜¸ì¶œ
          payload = {
              "model": "claude-sonnet-4-6",
              "max_tokens": 1500,
              "messages": [{
                  "role": "user",
                  "content": f"""Spring Boot / Java 21 í”„ë¡œì íŠ¸ PRì„ ë¦¬ë·°í•´ì£¼ì„¸ìš”.
PR ì œëª©: {pr_title}

ë‹¤ìŒ ê´€ì ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ í•œêµ­ì–´ë¡œ ë¦¬ë·°í•´ì£¼ì„¸ìš”:
1. ë²„ê·¸ / ì˜¤ë¥˜ ê°€ëŠ¥ì„±
2. ë³´ì•ˆ ì´ìŠˆ
3. ì½”ë“œ í’ˆì§ˆ ë° ì»¨ë²¤ì…˜
4. í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€

ë¬¸ì œê°€ ì—†ìœ¼ë©´ "âœ… íŠ¹ì´ì‚¬í•­ ì—†ìŒ" ìœ¼ë¡œ ëë‚´ì£¼ì„¸ìš”.

ë³€ê²½ì‚¬í•­:
{diff}"""
              }]
          }

          req = urllib.request.Request(
              'https://api.anthropic.com/v1/messages',
              data=json.dumps(payload).encode(),
              headers={
                  'x-api-key': api_key,
                  'anthropic-version': '2023-06-01',
                  'content-type': 'application/json'
              },
              method='POST'
          )
          with urllib.request.urlopen(req, timeout=60) as resp:
              data = json.loads(resp.read())

          review_text = data['content'][0]['text']

          # PR ëŒ“ê¸€ ìž‘ì„±
          comment = {'body': f'## ðŸ¤– Claude ì½”ë“œ ë¦¬ë·°\n\n{review_text}'}
          req2 = urllib.request.Request(
              f'https://api.github.com/repos/{repo}/issues/{pr_number}/comments',
              data=json.dumps(comment).encode(),
              headers={
                  'Authorization': f'Bearer {github_token}',
                  'Accept': 'application/vnd.github+json',
                  'content-type': 'application/json'
              },
              method='POST'
          )
          with urllib.request.urlopen(req2, timeout=10) as resp:
              result = json.loads(resp.read())
              print('ë¦¬ë·° ëŒ“ê¸€ ìž‘ì„± ì™„ë£Œ:', result['html_url'])
          PYEOF
